# ZTerm客户端和服务器的协议规范 1.0

本文档规定了ZTerm和服务器之间的通讯规范。 ZTerm和服务器之间通过HTTPS协议进行通讯。

## ZTerm发往服务器的数据包格式：

ZTerm发往服务器的数据包格式如下图所示：

![](x0007.svg)

数据包统一为UTF8编码格式，其中第一个字节表示该数据包的类型，目前支持X类型或者P类型。如果是X，表示后面的数据包是用户的提问信息。如果是P，表示是检测网络状态的数据包。

用户提问的数据包的格式描述如下：
- 第一个域为用户的公钥，共66个字节，由数字0-9和小写字母a-f表示。形式类似：03339a1c8fdb6aff46845e49d120e0400021e161b6341858585c2e25ca3d9c01ca。 
- 第二个域为一个64字节的随机数，表示某一个用户和服务器之间的会话。它由数字0-9和小写字母a-f表示，形式类似：fbe788e3aeaeb04ace43dad9bf776cb5cc7d01ee230bdc7ed0bf197ed28ebbc8。 该随机数由客户端随机产生。服务器根据此信息来判断一系列问话是否属于同一个session。
- 第三个域是4个字节的客户端版本信息，由数字0-9和小写字母a-f表示，目前是0810。
- 第四个域是用户的提问信息，长度可变。
- 第五个域是用户的屏幕信息，长度可变。该域是可选的，并不一定存在。该域的头4个字节是三个连续的双引号(")和一个换行符号(\n)。最后四个字节是一个换行符号(\n)和三个连续的双引号(")。

第一、二、三和四域之间由一个分隔符来分隔。目前分隔符统一为大写的X。第四和第五个域没有分隔符，可以通过第五个域的四个特殊字符来界定边界。

## 加密问题
通讯采用https协议，本身是加密的。如果想在应用数据上进一步加密，方法如下。

我们采用比特币内核所使用的secp256k1加密算法。 用户端自行产生自己的私钥S1和公钥P1。服务器端拥有自己的私钥S2和公钥P2。 客户端保存服务器的公钥P2。

私钥S1和S2均是32字节。公钥P1和P2均是33字节。它们之间有如下关系：
```
K = f(S1, P2)
K = f(S2, P1)
```
其中K是32字节。 上述公式表明，由我方私钥和对方公钥可以推导出一个32字节的秘钥K。 双方加密数据均使用K为加密的秘钥。

譬如，服务器保存的视频是加密的，加密秘钥Kv是32字节，服务器端采用K，利用AES256算法加密后发给客户端。那么，只有拥有私钥S1的用户才能够解密视频数据。

